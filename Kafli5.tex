Við höfum kynnst því hvernig búa má til töflur (kafli \ref{kafli:uppsetningtaflna}) og hvernig ná má í gögn úr töflunum (kafli \ref{kafli:select}). 

Þessi vitneskja getur komið okkur furðu langt - en ekki alveg nógu. Nú skulum við skoða hvernig vinna má með stærri töflur og margar töflur í sama grunninum.
\section{Lyklar}
\label{undirkafli:lyklar}
Lyklar\footnote{e. \emph{key} eða \emph{index}} eru mikilvægir í öllum skilvirkum gagnagrunnum. Lyklar eru m.a. notaðir til að gera fyrirspurnir hraðvirkari og til að tengja töflur saman.

Lyklar eru stundum kallaðir \emph{vísar}. ``Lykill'' og ``vísir'' þýða það sama þegar kemur að MySQL.
\subsection{Almennt um lykla - KEY/INDEX}
Ímyndum okkur að við séum að leita að bók sem geymd er á mjög frumstæðu bókasafni. Á þessu bókasafni eru nefnilega engir titlar á kili bókanna og allar bækurnar líta eins út.
Erfitt verk, ekki satt? Að meðaltali þyrftum við að fara í gegnum hálft bókasafnið áður en við rekumst á bókina sem við viljum.

Þetta er verkið sem stendur frammi fyrir gagnagrunnskerfum í hvert skipti sem við notum þau til að leita að gögnum í dálki sem ekki er með lykil.
Gagnagrunnskerfi geta ekki borið saman gögn án þess að lesa þau.
Sem betur fer eru tölvur mjög fljótar að bryðja sér leið í gegn um mikið magn af gögnum - en við getum gert betur en að geyma allar upplýsingarnar okkar ómerktar og óraðar.

Það að setja vísi á dálk í gagnagrunnstöflu samsvarar því að búa til bókasafnskerfi sem getur sagt okkur í hvaða hillum og hvar í hillunum við getum fundið hverja bók. Það gefur auga leið að þetta gerir leitina auðveldari.

Hver tafla getur haft marga lykla.
\subsection{Einkvæmir lyklar - UNIQUE KEY}
Hægt er að setja þá takmörkun á lykil að öll stök sem honum tilheyra þurfi að vera einstök.

Slíkur lykill, sem kalla má einkvæman lykil\footnote{e. \emph{unique key} eða \emph{unique index}}, hefur þá ekki einungis það hlutverk að gera leit í gagnagrunninum auðveldari, heldur einnig það hlutverk að passa upp á að gögnin séu einstök.

Íslenskar kennitölur eru dæmi um gögn sem oft væri gott að vera með einkvæman lykil á. Það að fletta upp kennitölum er algeng aðgerð og við vitum að allar kennitölur eiga að vera einstakar.
\subsection{Aðallyklar - PRIMARY KEY}
\label{undirkafli:adallyklar}
Við höfum kynnst aðallyklum áður. Við sáum útskýringu á hvernig búa má til slíkan lykil í undirkafla \ref{undirkafli:adallyklar-kynning}.

Nú getum við séð að aðallykill er ekkert annað en sérstök gerð af einkvæmum lykli. Aðallykill er lykill sem hefur það sérstaka hlutverk að einkenna hverja línu fyrir sig, svo að hægt sé að vísa í hana á ótvíræðan hátt.

Þar sem að aðallykill töflu á að geta einkennt hverja línu er oftast best að lykillinn sé ekki byggður á gögnunum í línunni \footnote{af því að við viljum alls ekki þurfa að breyta aðallykli línu ef að gögnin breytast}. Einnig er gott að aðallykillinn sé lítill og einfaldur\footnote{Vegna þess að hann er oftast mikið notaður af gagnagrunnskerfinu.}. 

Kennitölur eru þess vegna ekki sérstaklega góðir aðallyklar. Þær geyma upplýsingar um einstaklinginn (fæðingardagsetningu hans), þær geta breyst (þó það sé sjaldgæft) og þær eru langar (sem er tímafrekt að lesa). Þess vegna eru romsur á borð við þá sem við höfum séð í \verb|CREATE TABLE| skipunum, \verb|id INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT| mikið notaðar til að skilgreina aðallykla. Þær búa til lykla sem 
\begin{itemize}
 \item Auðkenna línuna fullkomlega
 \item Eru heiltölur (og þar með litlar og auðveldar í vinnslu)
 \item Eru aldrei \verb|NULL|
 \item Og eru óháðir gögnunum.
\end{itemize}
Þó að tafla geti verið með marga lykla, þá er hver tafla aðeins með einn aðallykil.

\begin{example}
\caption[PRIMARY KEY]{Til upprifjunar: aðallykill skilgreindur sem hluti af \emph{CREATE TABLE} skipun. Þessi skipun býr til töflu \ref{tafla:nemendur}, sem við notuðum mikið í síðasta kafla.}
\label{sql:k5d1-primary-key}
\centering
\sql{sql/k5d1-primary-key.sql}
\end{example}
\subsection{(Ekki) meira um lykla}
Lyklar eru stórt viðfangsefni sem ekki er hægt að snerta á nema að mjög litlu leyti í þessari bók. Við munum ekki kafa dýpra í þá hér, heldur munum við láta þá bíða bóka og námskeiða fyrir lengra komna.

Í bili, þá skulum við láta okkur duga að muna að
\begin{itemize}
 \item Lyklar eru mikilvægir til að gagnagrunnskerfi geti unnið á skilvirkan hátt
 \item Við kunnum að búa til aðallykla 
 \item Aðallyklar geta auðkennt hverja línu í gagnagrunninum fyrir sig.
\end{itemize}
Síðasta atriðið verður sérstaklega mikilvægt þegar við förum að nota margar töflur í sama gagnagrunninum.
\section{Margar töflur í sama gagnagrunninum}
Við komumst að því strax í kafla \ref{kafli:fyrstuskrefin} að gagnagrunnur getur innihaldið margar töflur. Hingað til höfum við samt verið að vinna með töflur eina í einu, óháð hvor annarri.

Lítum á dæmi um hvernig tvær töflur sem eru staddar í sama gagnagrunni geta tengst. Skoðum aftur áfangatöfluna okkar frá því í síðasta kafla (\ref{tafla:afangar-aftur}).

\begin{table}
\centering
\caption[Áfangar]{Tafla \ref{tafla:afangar} endurtekin.}
\label{tafla:afangar-aftur}
\begin{tabular}{llll}
\toprule
numer&audkenni&fag&onn\\
\midrule
1&	FOR1A3U&	Forritun&		1\\
2&	VSH1A3U&	Vefhönnun&		1\\
3&	GSÖ1G2U&	Notkun gagnasafna&	1\\
4&	TÆK1A1U&	Tölvutækni&		1\\
5&	FOR1B3U&	Forritun&		2\\
6&	VSH2A3U&	Vefhönnun&		2\\
7&	GSÖ1F2U&	Notkun gagnasafna&	2\\
8&	TÆK2A3U&	Tölvutækni&		2\\
9&	FOR2B2U&	Forritun&		3\\
10&	VSH2B2U&	Vefhönnun&		3\\
11&	GSÖ2B2U&	Notkun gagnasafna&	3\\
12&	TÆK2B2U&	Tölvutækni&		3\\
13&	GRU2L4U&	Lokaverkefni grunndeildar&3\\
\bottomrule
\end{tabular}
\end{table}

Sú tafla er ágæt, en við getum gert hana betri með því að skipta henni upp í tvær töflur sem eru tengdar saman.\footnote{Af hverju er betra að vera ekki með svona endurtekningar? Hér má til dæmis nefna minni plásseyðslu og hversu mikið auðveldara verður að uppfæra gildin í töflunum séu engar endurtekningar til staðar.} Tökum eftir því að nafnið á hverju fagi er endurtekið í dálkinum \emph{fag}. 

Við gætum komist hjá þessari endurtekningu með því að geyma nöfnin á fögunum í sérstakri töflu.\footnote{Það sem við erum að gera hér er kallað að ``normalísera'' (e. \emph{normalize}) gagnagrunninn. Normalísering er viðfangsefni fyrir lengra komna.} Sú tafla gæti verið eins og tafla \ref{tafla:fog}.
Þar má sjá að við höfum gefið hverju fagi númer. Gefum okkur það að dálkurinn sem inniheldur þau númer sé aðallykill (sjá undirkafla \ref{undirkafli:adallyklar}). Þá getum við notað númerin til þess að vísa í línurnar. Þetta hefur verið gert á töflu \ref{tafla:afangar-fagnumer}, nöfnunum á fögunum hefur verið skipt út fyrir númer þeirra í töflu \ref{tafla:fog}.

\begin{table}
\centering
\caption[Fög]{Fög, sem áður voru í gömlu áfangatöflunni (\ref{tafla:afangar}/\ref{tafla:afangar-aftur}). Þessa töflu má tengja við endurbættu áfangatöfluna - töflu \ref{tafla:afangar-fagnumer}.}
\label{tafla:fog}
\begin{tabular}{ll}
\toprule
numer&fag\\
\midrule
1&Forritun\\
2&Vefhönnun\\
3&Notkun gagnasafna\\
4&Tölvutækni\\
5&Lokaverkefni grunndeildar\\
\bottomrule
\end{tabular}
\end{table}

\begin{table}
\centering
\caption[Áfangar - endurbætt]{Áfangataflan, þar sem nöfnunum á fögunum hefur verið skipt út fyrir númer þeirra, sem birtast í töflu \ref{tafla:fog}.}
\label{tafla:afangar-fagnumer}
\begin{tabular}{llll}
\toprule
numer&audkenni&fagNumer&onn\\
\midrule
1&	FOR1A3U&	1&	1\\
2&	VSH1A3U&	2&	1\\
3&	GSÖ1G2U&	3&	1\\
4&	TÆK1A1U&	4&	1\\
5&	FOR1B3U&	1&	2\\
6&	VSH2A3U&	2&	2\\
7&	GSÖ1F2U&	3&	2\\
8&	TÆK2A3U&	4&	2\\
9&	FOR2B2U&	1&	3\\
10&	VSH2B2U&	2&	3\\
11&	GSÖ2B2U&	3&	3\\
12&	TÆK2B2U&	4&	3\\
13&	GRU2L4U&	5&	3\\
\bottomrule
\end{tabular}
\end{table}

Hægt er að búa til mjög stórar fjölskyldur af töflum með því að tengja þær saman á þennan hátt með sameiginlegum gildum.

\begin{figure}
\caption[Tengsl taflna]{Sýnir hvernig töflur \ref{tafla:fog} og \ref{tafla:afangar-fagnumer} tengjast saman á dálkunum \emph{fagNumer} og \emph{fag}. (Töflurnar eru ekki sýndar í heilu lagi.)}
\label{mynd:tengsl}
\centering
\includegraphics[width=\linewidth]{myndir/foreign-key}
\end{figure}

\section{Aðkomulyklar} % FOREIGN KEY
Þegar gildi í dálki eiga að vísa í línur annarrar töflu er hægt að tryggja sambandið með því að búa til svokallaðan aðkomulykil\footnote{e. \emph{Foreign key}.}.

Aðkomulykill myndar formlegt samband á milli tveggja taflna. Taflan sem inniheldur gögnin sjálf er kölluð foreldrið í sambandinu. Taflan sem inniheldur vísunina í gögnin er kölluð barnið\footnote{e. \emph{parent table} annars vegar og \emph{child table} hins vegar}. Í dæminu okkar á undan er \ref{tafla:fog} því foreldrið og \ref{tafla:afangar-fagnumer} barnið.

Aðkomulykillinn passar upp á að barnið geti ekki vísað í gögn sem ekki eru til í foreldrinu. Sé reynt að nota \verb|INSERT| skipun á barnið til að setja inn vísun í línu sem ekki er til í foreldrinu veldur það villu sé lykillinn rétt upp settur.

Aðkomulykillinn er skilgreindur í \verb|CREATE TABLE| skipun barnsins.

Mikilvægt er að dálkarnir í barninu og foreldrinu passi saman m.t.t. gagnagerðar (\ref{undirkafli:gagnagerdir}). Oftast er tengt saman á heiltöludálkum (sem þurfa að vera af sömu stærð).

Dálkurinn í foreldrinu sem aðkomulykillinn vísar í þarf að hafa aðallykill eða einkvæman lykill. Væri svo ekki gæti gagnagrunnskerfið ekki verið visst um hvaða línu í foreldrinu vísunin í barninu ætti við.
\section{Tengingar} % 1-1, 1-N, N-N







